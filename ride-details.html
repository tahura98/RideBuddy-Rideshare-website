<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Ride details – RideBuddy</title>
  <style>
    :root {
      --bg: #020617;
      --card-bg: #020617;
      --muted: #9ca3af;
      --accent: #2f80ed;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }

    body {
      background: radial-gradient(circle at top, #111827 0, #020617 45%, #000 100%);
      color: #e5e7eb;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    header {
      height: 64px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 7vw;
      border-bottom: 1px solid rgba(148, 163, 184, 0.25);
    }

    .brand {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .brand-mark {
      width: 28px;
      height: 28px;
      border-radius: 999px;
      background: #fff;
      color: #000;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      font-weight: 700;
    }

    .brand-text {
      font-size: 18px;
      font-weight: 700;
    }

    nav {
      display: flex;
      align-items: center;
      gap: 16px;
      font-size: 14px;
      color: #9ca3af;
    }

    nav a {
      color: #9ca3af;
      text-decoration: none;
    }

    nav a:hover {
      color: #e5e7eb;
    }

    .btn-nav {
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.6);
      background: transparent;
      color: #e5e7eb;
      padding: 6px 12px;
      font-size: 13px;
      cursor: pointer;
    }

    main {
      flex: 1;
      padding: 28px 7vw 40px;
      display: flex;
      justify-content: center;
    }

    .card {
      background: rgba(15, 23, 42, 0.9);
      border-radius: 20px;
      padding: 22px 20px;
      border: 1px solid rgba(148, 163, 184, 0.35);
      box-shadow: 0 18px 45px rgba(15, 23, 42, 0.85);
      width: 100%;
      max-width: 720px;
    }

    .title-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }

    .route {
      font-size: 20px;
      font-weight: 600;
    }

    .badge {
      padding: 3px 8px;
      border-radius: 999px;
      border: 1px solid rgba(56, 189, 248, 0.8);
      font-size: 11px;
      color: #bfdbfe;
    }

    .meta {
      font-size: 13px;
      color: #9ca3af;
      margin-bottom: 12px;
    }

    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 12px;
      margin-top: 8px;
      margin-bottom: 14px;
    }

    .stat {
      font-size: 13px;
      background: rgba(15, 23, 42, 0.9);
      border-radius: 14px;
      border: 1px solid rgba(148, 163, 184, 0.3);
      padding: 10px 12px;
    }

    .stat-label {
      font-size: 11px;
      color: #9ca3af;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      margin-bottom: 3px;
    }

    .stat-value {
      font-size: 13px;
    }

    .note {
      font-size: 13px;
      color: #cbd5f5;
      margin-top: 4px;
    }

    .buttons {
      margin-top: 18px;
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
    }

    .btn-primary {
      padding: 9px 16px;
      border-radius: 999px;
      border: none;
      background: #f9fafb;
      color: #020617;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
    }

    .btn-secondary {
      padding: 9px 16px;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.7);
      background: transparent;
      color: #e5e7eb;
      font-size: 13px;
      cursor: pointer;
    }

    .helper-text {
      font-size: 11px;
      color: #9ca3af;
      margin-top: 6px;
    }

    .story-section {
      margin-top: 20px;
    }

    .story-title {
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 6px;
    }

    .story-list {
      font-size: 12px;
      color: #cbd5f5;
      border-radius: 12px;
      border: 1px solid rgba(148, 163, 184, 0.3);
      padding: 8px 10px;
      max-height: 160px;
      overflow-y: auto;
    }

    .story-item {
      margin-bottom: 4px;
    }

    .story-item span {
      color: #9ca3af;
    }

    footer {
      font-size: 11px;
      padding: 12px 7vw 16px;
      color: #6b7280;
      border-top: 1px solid rgba(15, 23, 42, 0.8);
    }

    @media (max-width: 700px) {
      header {
        padding: 0 16px;
      }

      main {
        padding: 24px 16px 32px;
      }
    }
  </style>
</head>

<body>
  <header>
    <div class="brand">
      <div class="brand-mark">RB</div>
      <div class="brand-text">RideBuddy</div>
    </div>
    <nav>
      <a href="home.html">Back</a>
      <a href="profile.html">Profile</a>
      <button class="btn-nav" id="logoutBtn" type="button">Log out</button>
    </nav>
  </header>

  <main>
    <div class="card" id="detailsCard">
    </div>
  </main>

  <footer>RideBuddy – Ride details (connected to JSON backend).</footer>

  <script src="app.js"></script>
  <script>
    document.addEventListener("DOMContentLoaded", async function () {
      if (!isLoggedIn()) { window.location.href = "login.html"; return; }
      const currentUser = getCurrentUser();
      if (!currentUser) { await logoutUser(); window.location.href = "login.html"; return; }

      document.getElementById("logoutBtn").addEventListener("click", async function () {
        await logoutUser();
        window.location.href = "index.html";
      });

      const card = document.getElementById("detailsCard");
      const ride = getSelectedRide();
      if (!ride) {
        card.innerHTML = `
        <div style="font-size:16px;font-weight:600;margin-bottom:8px;">No ride selected</div>
        <div class="meta">Please go back to Find a ride and choose a ride first.</div>
        <button class="btn-secondary" type="button" onclick="window.location.href='find-ride.html'">← Back to search</button>
      `;
        return;
      }

      let freshRide = ride;
      if (ride.id != null) {
        try {
          freshRide = await getRideById(ride.id) || ride;
        } catch (e) {
          console.error(e);
        }
      }

      setSelectedRide(freshRide);

      const from = freshRide.from_location || "Unknown start";
      const to = freshRide.to_location || "Unknown destination";
      const dateText = freshRide.date || "Unknown date";
      const timeText = freshRide.time || "Time not set";
      const driver = freshRide.driver_name || "Unknown driver";
      const status = freshRide.status || "Active";

      const seatsNumber = (typeof freshRide.available_seats === "number") ? freshRide.available_seats : null;
      const seatsText = seatsNumber != null ? `${seatsNumber} seat(s)` : "—";
      const fareText = (freshRide.fare_per_seat != null) ? `৳${freshRide.fare_per_seat} per seat` : "—";

      const pref = freshRide.passenger_preference || "any";
      let prefText = "Any passenger";
      if (pref === "female_only") prefText = "Female passengers only";
      else if (pref === "female_pref") prefText = "Female preferred";

      const noteText = freshRide.note || "No additional notes from driver.";

      card.innerHTML = `
      <div class="title-row">
        <div class="route">${from} → ${to}</div>
        <div class="badge" id="statusBadge">${status}</div>
      </div>
      <div class="meta">
        ${dateText} · ${timeText}<br/>
        Driver: <strong>${driver}</strong>
      </div>

      <div class="grid">
        <div class="stat">
          <div class="stat-label">Fare</div>
          <div class="stat-value">${fareText}</div>
        </div>
        <div class="stat">
          <div class="stat-label">Seats available</div>
          <div class="stat-value" id="seatValue">${seatsText}</div>
        </div>
        <div class="stat">
          <div class="stat-label">Passenger preference</div>
          <div class="stat-value">${prefText}</div>
        </div>
      </div>

      <div class="stat">
        <div class="stat-label">Driver note</div>
        <div class="note">${noteText}</div>
      </div>

      <div class="buttons" id="buttonsContainer"></div>
      <div class="helper-text" id="helperText"></div>
    `;

      const buttons = document.getElementById("buttonsContainer");
      const helper = document.getElementById("helperText");
      const seatValueEl = document.getElementById("seatValue");
      const statusBadgeEl = document.getElementById("statusBadge");

      const isDriver = Number(freshRide.driver_id) === Number(currentUser.id);

      const backBtn = document.createElement("button");
      backBtn.type = "button";
      backBtn.className = "btn-secondary";
      backBtn.textContent = "← Back to search";
      backBtn.onclick = () => window.location.href = "find-ride.html";

      const chatBtn = document.createElement("button");
      chatBtn.type = "button";
      chatBtn.className = "btn-secondary";
      chatBtn.textContent = "Open chat";
      chatBtn.onclick = () => window.location.href = "chat.html";

      if (isDriver) {
        const closeBtn = document.createElement("button");
        closeBtn.type = "button";
        closeBtn.className = "btn-primary";
        closeBtn.textContent = "Close this ride";

        closeBtn.onclick = async () => {
          try {
            await updateRide(freshRide.id, { status: "Closed" });
            freshRide.status = "Closed"; 
            setSelectedRide(freshRide);

            statusBadgeEl.textContent = "Closed";
            helper.textContent = "Ride is now closed.";
            alert("Ride closed successfully.");
          } catch (e) {
            alert(e.message || "Failed to close ride");
          }
        };

        buttons.appendChild(closeBtn);
        buttons.appendChild(chatBtn);
        buttons.appendChild(backBtn);

        helper.textContent = "You are the driver of this ride.";
        return;
      }

      const requestBtn = document.createElement("button");
      requestBtn.type = "button";
      requestBtn.className = "btn-primary";
      requestBtn.textContent = "Request this ride";

      if (freshRide.id == null) {
        requestBtn.disabled = true;
        helper.textContent = "This is a static demo ride. Booking disabled.";
      } else if ((status || "").toLowerCase() === "closed") {
        requestBtn.disabled = true;
        helper.textContent = "This ride is closed.";
      } else if (seatsNumber !== null && seatsNumber <= 0) {
        requestBtn.disabled = true;
        helper.textContent = "No seats left on this ride.";
      }

      requestBtn.onclick = async () => {
        try {
          const booking = await createBooking({ rideId: freshRide.id, seats: 1 });

          const updatedRide = await getRideById(freshRide.id);
          if (updatedRide) {
            setSelectedRide(updatedRide);
            if (typeof updatedRide.available_seats === "number") {
              seatValueEl.textContent = `${updatedRide.available_seats} seat(s)`;
            }
          }

          window.location.href = "ride-book.html?bookingId=" + encodeURIComponent(booking.id);
        } catch (e) {
          alert(e.message || "Failed to create booking");
        }
      };

      buttons.appendChild(requestBtn);
      buttons.appendChild(chatBtn);
      buttons.appendChild(backBtn);
      if (!helper.textContent) helper.textContent = "Request will reserve 1 seat and move you to booking confirmation.";
    });
  </script>

</body>

</html>