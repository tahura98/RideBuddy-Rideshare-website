<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Ride History – RideBuddy</title>
  <style>
    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: radial-gradient(circle at top, #111827 0, #020617 45%, #000 100%);
      color: #e5e7eb;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    header {
      height: 64px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 7vw;
      border-bottom: 1px solid rgba(148, 163, 184, 0.25);
    }

    .brand {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .brand-mark {
      width: 28px;
      height: 28px;
      border-radius: 999px;
      background: #fff;
      color: #000;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      font-weight: 700;
    }

    .brand-text {
      font-size: 18px;
      font-weight: 700;
    }

    header nav {
      display: flex;
      align-items: center;
      gap: 16px;
      font-size: 14px;
      color: #9ca3af;
    }

    main {
      flex: 1;
      padding: 28px 7vw 40px;
      display: grid;
      grid-template-columns: minmax(0, 1fr);
      gap: 24px;
      max-width: 900px;
      margin: 0 auto;
    }

    .card {
      background: rgba(15, 23, 42, 0.9);
      border-radius: 20px;
      padding: 22px 20px;
      border: 1px solid rgba(148, 163, 184, 0.35);
      box-shadow: 0 18px 45px rgba(15, 23, 42, 0.85);
      margin-bottom: 16px;
    }

    .ride-meta {
      font-size: 13px;
      color: #9ca3af;
    }

    .btn-main {
      padding: 10px 16px;
      border-radius: 999px;
      border: none;
      background: #f9fafb;
      color: #020617;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
    }

    footer {
      font-size: 11px;
      padding: 12px 7vw 16px;
      color: #6b7280;
      border-top: 1px solid rgba(15, 23, 42, 0.8);
    }
  </style>
</head>

<body>
  <header>
    <div class="brand">
      <div class="brand-mark">RB</div>
      <div class="brand-text">RideBuddy</div>
    </div>
    <nav>
      <a href="home.html">Home</a>
      <span style="color:#e5e7eb;">Ride History</span>
    </nav>
  </header>

  <main>
    <div class="card">
      <h2>Recent Rides</h2>
      <div class="ride-meta">
        <p>Bashundhara R/A → IUB North Gate</p>
        <p>Status: Completed · Rating: 4.8★</p>
      </div>
      <button class="btn-main" onclick="window.location.href='rate-ride.html'">Rate this ride</button>
    </div>

    <div class="card">
      <div class="ride-meta">
        <p>Rampura → IUB Main Gate</p>
        <p>Status: Completed · Rating: 5★</p>
      </div>
    </div>
  </main>

  <footer>RideBuddy – Ride History</footer>
  
  <script src="app.js"></script>
  <script>
    document.addEventListener("DOMContentLoaded", async function () {
      if (!isLoggedIn()) { window.location.href = "login.html"; return; }
      const user = getCurrentUser();
      if (!user) { await logoutUser(); window.location.href = "login.html"; return; }

      const wrap = document.getElementById("rideHistory");
      if (!wrap) return;

      let bookings = [];
      try {
        bookings = await getUserBookings(user.id);
      } catch (e) {
        console.error(e);
      }

      if (!bookings || !bookings.length) {
        wrap.innerHTML = `
        <div class="card">
          <h2>Recent Rides</h2>
          <div class="ride-meta">No bookings yet. Go to Find a ride and book one.</div>
          <button class="btn-main" onclick="window.location.href='find-ride.html'">Find a ride</button>
        </div>
      `;
        return;
      }

      wrap.innerHTML = "";
      bookings.forEach(bk => {
        const from = bk.from_location || "—";
        const to = bk.to_location || "—";
        const when = `${bk.date || ""} ${bk.time || ""}`.trim() || "—";

        const canRate = (bk.status === "COMPLETED" || bk.status === "PAID") && !bk.rating_given;

        const card = document.createElement("div");
        card.className = "card";
        card.innerHTML = `
        <h2>${from} → ${to}</h2>
        <div class="ride-meta">
          <p>${when}</p>
          <p>Status: <strong>${bk.status}</strong> · Seats: ${bk.seats} · Fare: ৳${bk.fare_per_seat}</p>
          <p>Driver: <strong>${bk.driver_name || "Driver"}</strong></p>
        </div>

        <div style="margin-top:12px;display:flex;gap:10px;flex-wrap:wrap;">
          <button class="btn-main" data-action="chat">Chat</button>
          ${canRate ? `<button class="btn-main" data-action="rate">Rate</button>` : ``}
        </div>
      `;

        card.querySelector('[data-action="chat"]').onclick = async () => {
      
          try {
            const ride = await getRideById(bk.ride_id);
            if (ride) {
              setSelectedRide(ride);
              window.location.href = "chat.html";
            } else {
              alert("Ride details not found");
            }
          } catch (e) {
            console.error(e);
            alert("Error opening chat");
          }
        };

        const rateBtn = card.querySelector('[data-action="rate"]');
        if (rateBtn) {
          rateBtn.onclick = () => {
         
            window.location.href = "ride-rating.html?bookingId=" + encodeURIComponent(bk.id);
          };
        }

        wrap.appendChild(card);
      });
    });
  </script>


</body>

</html>